<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gestionar Torneo — PadelFlow</title>
    <link rel="stylesheet" href="/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="stylesheet" href="/assets/css/styles.css" />
    <link rel="stylesheet" href="/assets/css/dashboard.css" />
    <link rel="stylesheet" href="/swiper/swiper-bundle.min.css" />
    <style>
        .fixed-bottom-bar {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1050;
            background: transparent;
            box-shadow: none;
            border: none;
            padding: 0;
            display: flex;
            justify-content: flex-end;
        }

        .bracket {
            display: flex;
            overflow-x: auto;
            padding: 20px;
            background-color: #f9f9f9;
        }

        .round {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            margin-right: 40px;
            min-width: 250px;
        }

        .match {
            position: relative;
            margin-bottom: 30px;
        }

        .match-connector {
            position: absolute;
            top: 50%;
            right: -20px;
            width: 20px;
            height: 2px;
            background-color: #ccc;
        }

        .match-connector-branch {
            position: absolute;
            top: 50%;
            left: -20px;
            width: 20px;
            height: 2px;
            background-color: #ccc;
        }

        .round-connector-left {
            position: absolute;
            width: 2px;
            background-color: #ccc;
            left: -22px;
            /* Half of margin-right */
        }

        .round-connector-right {
            position: absolute;
            width: 2px;
            background-color: #ccc;
            right: -22px;
            /* Half of margin-right */
        }
    </style>
</head>

<body>
        <%- include('partials/club_header') %>
        <div class="admin-shell">
            <%- include('partials/club_sidebar', { club: club }) %>
                <div class="main flex-grow-1">
                    <main class="container-fluid p-4">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h1 class="h3 mb-0">Gestionar Torneo: <%= viewModel.tournament.name %>
                            </h1>
                            <div>
                                <form action="/club/tournaments/<%= viewModel.tournament.id %>/delete" method="POST"
                                    class="d-inline"
                                    onsubmit="return confirm('¿Estás seguro de que quieres borrar este torneo? Esta acción no se puede deshacer.');">
                                    <button type="submit" class="btn btn-danger me-2"><i
                                            class="fas fa-trash-alt me-1"></i> Borrar</button>
                                </form>
                                <a href="/club/tournaments/<%= viewModel.tournament.id %>/edit"
                                    class="btn btn-outline-primary me-2"><i class="fas fa-pencil-alt me-1"></i> Editar
                                    Torneo</a>
                                <a href="/club/dashboard" class="btn btn-secondary"><i
                                        class="fas fa-arrow-left me-1"></i>
                                    Volver</a>
                            </div>
                        </div>

                        <div class="card mb-4">
                            <div class="card-header">
                                <h5><i class="fas fa-info-circle me-2"></i>Resumen del Torneo</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>Descripción:</strong>
                                    <%= viewModel.tournament.description || 'No hay descripción.' %>
                                </p>
                                <div class="row">
                                    <div class="col-md-3">
                                        <p><strong>Tipo:</strong> <span class="badge bg-secondary">
                                                <%= viewModel.tournament.type %>
                                            </span></p>
                                    </div>
                                    <div class="col-md-3">
                                        <p><strong>Duración:</strong>
                                            <%= viewModel.tournament.setting.match_duration %> min
                                        </p>
                                    </div>
                                    <div class="col-md-3">
                                        <p><strong>Inicio:</strong>
                                            <%= new Date(viewModel.tournament.start_date).toLocaleString('es-ES', {
                                                year: 'numeric' , month: '2-digit' , day: '2-digit' , hour: '2-digit' ,
                                                minute: '2-digit' }) %>
                                        </p>
                                    </div>
                                    <div class="col-md-3">
                                        <p><strong>Fin:</strong>
                                            <%= new Date(viewModel.tournament.end_date).toLocaleString('es-ES', {
                                                year: 'numeric' , month: '2-digit' , day: '2-digit' , hour: '2-digit' ,
                                                minute: '2-digit' }) %>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Player Management (Conditional) -->
                        <% if (viewModel.view.isPending) { %>
                            <div class="row mb-4">
                                <!-- Registered Players -->
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5><i class="fas fa-users me-2"></i>Jugadores Inscritos</h5>
                                        </div>
                                        <div class="card-body">
                                            <% const groupedPlayers={}; const ungroupedPlayers=[];
                                                viewModel.registeredPlayers.forEach(p=> {
                                                if (p.players_team_id) {
                                                if (!groupedPlayers[p.players_team_id]) {
                                                groupedPlayers[p.players_team_id] = [];
                                                }
                                                groupedPlayers[p.players_team_id].push(p);
                                                } else {
                                                ungroupedPlayers.push(p);
                                                }
                                                });
                                                %>

                                                <!-- Jugadores con grupo -->
                                                <h6>Jugadores con grupo</h6>
                                                <% if (Object.keys(groupedPlayers).length> 0) { %>
                                                    <ul class="list-group mb-3">
                                                        <% Object.values(groupedPlayers).forEach(team=> { %>
                                                            <li
                                                                class="list-group-item d-flex justify-content-between align-items-center">
                                                                <div>
                                                                    <% team.forEach(player=> { %>
                                                                        <span class="badge bg-primary me-1">
                                                                            <%= player.name %>
                                                                        </span>
                                                                        <% }); %>
                                                                </div>
                                                                <form
                                                                    action="/club/tournaments/<%= viewModel.tournament.id %>/ungroup/<%= team[0].players_team_id %>"
                                                                    method="POST"
                                                                    onsubmit="return confirm('¿Estás seguro de que quieres desagrupar a estos jugadores?');">
                                                                    <button type="submit"
                                                                        class="btn btn-sm btn-warning">Desagrupar</button>
                                                                </form>
                                                            </li>
                                                            <% }); %>
                                                    </ul>
                                                    <% } else { %>
                                                        <p class="text-muted">No hay jugadores agrupados.</p>
                                                        <% } %>

                                                            <!-- Jugadores sin grupo -->
                                                            <h6 class="mt-4">Jugadores sin grupo</h6>
                                                            <input type="text" id="searchRegistered"
                                                                class="form-control mb-3"
                                                                placeholder="Buscar jugadores sin grupo...">
                                                            <% if (ungroupedPlayers.length> 0) { %>
                                                                <ul class="list-group" id="ungroupedPlayersList">
                                                                    <% ungroupedPlayers.forEach(player=> { %>
                                                                        <li
                                                                            class="list-group-item d-flex justify-content-between align-items-center">
                                                                            <%= player.name %>
                                                                                <form
                                                                                    action="/club/tournaments/<%= viewModel.tournament.id %>/remove_player/<%= player.id %>"
                                                                                    method="POST"
                                                                                    onsubmit="return confirm('¿Estás seguro de que quieres eliminar a este jugador del torneo?');">
                                                                                    <button type="submit"
                                                                                        class="btn btn-sm btn-danger"><i
                                                                                            class="fas fa-trash-alt"></i></button>
                                                                                </form>
                                                                        </li>
                                                                        <% }); %>
                                                                </ul>
                                                                <% } else { %>
                                                                    <p class="text-muted">No hay jugadores sin grupo.
                                                                    </p>
                                                                    <% } %>
                                        </div>
                                    </div>
                                </div>

                                <!-- Add Player Form Dinámico -->
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5><i class="fas fa-user-plus me-2"></i>Añadir Jugadores al Torneo
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <label for="playerSearch" class="form-label">Buscar Jugador</label>
                                            <input type="text" id="playerSearch" class="form-control mb-2"
                                                placeholder="Buscar jugadores..." autocomplete="off"
                                                data-tournament-id="<%= viewModel.tournament.id %>">
                                            <div id="playerList" class="list-group mb-2"
                                                style="max-height: 300px; overflow-y: auto;"></div>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-outline-primary mt-3" data-bs-toggle="modal"
                                    data-bs-target="#groupModal">
                                    <i class="fas fa-users me-1"></i> Crear grupo (2 jugadores)
                                </button>
                            </div>
                            <% } %>

                                <!-- Active Tournament Matches (Conditional) -->
                                <% if (viewModel.view.isActive && viewModel.matches && viewModel.matches.length> 0) { %>
                                    <% if (viewModel.view.isElimination) { %>
                                        <%- include('partials/tournament_elimination_view', { bracketData:
                                            viewModel.bracketData, phaseLabel: viewModel.phaseLabel, roundsA:
                                            viewModel.roundsA, roundsB: viewModel.roundsB }) %>
                                            <% } else { %>
                                                <div class="card mb-4">
                                                    <div
                                                        class="card-header d-flex justify-content-between align-items-center">
                                                        <h5><i class="fas fa-volleyball-ball me-2"></i>Partidos de la
                                                            Ronda
                                                            Actual</h5>
                                                        <form method="POST"
                                                            action="/club/tournaments/<%= viewModel.tournament.id %>/next_round"
                                                            class="d-inline">
                                                            <input type="hidden" name="currentRound"
                                                                value="<%= (viewModel.matches[0] && viewModel.matches[0].phase && viewModel.matches[0].phase.match(/\d+/)) ? viewModel.matches[0].phase.match(/\d+/)[0] : 1 %>">
                                                            <button type="submit" class="btn btn-success btn-sm"><i
                                                                    class="fas fa-forward me-1"></i>Generar siguiente
                                                                ronda</button>
                                                        </form>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="row">
                                                            <% viewModel.matches.forEach(function(match, idx) { %>
                                                                <div class="col-md-6 col-lg-4 mb-4">
                                                                    <div class="card h-100">
                                                                        <div
                                                                            class="card-header d-flex justify-content-between align-items-center">
                                                                            <h6 class="mb-0">Partido <%= idx + 1 %>
                                                                            </h6>
                                                                            <%- match.phaseLabel %>
                                                                        </div>
                                                                        <div class="card-body">
                                                                            <p class="card-text"><strong>Pista:</strong>
                                                                                <%= match.court_id || '-' %>
                                                                            </p>
                                                                            <div class="mb-3">
                                                                                <strong>Equipo A:</strong>
                                                                                <div>
                                                                                    <% match?.players?.teamA?.forEach(function(player)
                                                                                        { %>
                                                                                        <span
                                                                                            class="badge bg-primary me-1">
                                                                                            <%= player.name %>
                                                                                        </span>
                                                                                        <% }); %>
                                                                                </div>
                                                                            </div>
                                                                            <div class="mb-3">
                                                                                <strong>Equipo B:</strong>
                                                                                <div>
                                                                                    <% match?.players?.teamB?.forEach(function(player)
                                                                                        { %>
                                                                                        <span
                                                                                            class="badge bg-success me-1">
                                                                                            <%= player.name %>
                                                                                        </span>
                                                                                        <% }); %>
                                                                                </div>
                                                                            </div>
                                                                            <p class="card-text">
                                                                                <strong>Resultado:</strong>
                                                                                <%= match.score || '-' %>
                                                                            </p>
                                                                            <div>
                                                                                <strong>Ganador:</strong>
                                                                                <% if (match.score) { var setsA=0,
                                                                                    setsB=0;
                                                                                    match.score.split(',').forEach(function(setStr)
                                                                                    { var
                                                                                    parts=setStr.trim().split('-'); var
                                                                                    a=parseInt(parts[0],10),
                                                                                    b=parseInt(parts[1],10); if
                                                                                    (!isNaN(a) && !isNaN(b)) { if (a> b)
                                                                                    setsA++;
                                                                                    else if (b > a) setsB++;
                                                                                    }
                                                                                    });
                                                                                    if (setsA > setsB) { %>
                                                                                    <span
                                                                                        class="badge bg-primary">Equipo
                                                                                        A</span>
                                                                                    <% } else if (setsB> setsA) { %>
                                                                                        <span
                                                                                            class="badge bg-success">Equipo
                                                                                            B</span>
                                                                                        <% } else { %>
                                                                                            <span
                                                                                                class="badge bg-secondary">Empate</span>
                                                                                            <% } } else { %>
                                                                                                <span
                                                                                                    class="text-muted">-</span>
                                                                                                <% } %>
                                                                            </div>
                                                                        </div>
                                                                        <div class="card-footer text-center">
                                                                            <button class="btn btn-sm btn-warning"
                                                                                data-bs-toggle="modal"
                                                                                data-bs-target="#scoreModal"
                                                                                data-match-id="<%= match.id %>"
                                                                                data-match-idx="<%= idx+1 %>">Registrar
                                                                                resultado</button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <% }); %>
                                                        </div>
                                                    </div>
                                                </div>
                                                <% } %>
                                                    <!-- Modal para registrar resultado -->
                                                    <div class="modal fade" id="scoreModal" tabindex="-1"
                                                        aria-labelledby="scoreModalLabel" aria-hidden="true">
                                                        <div class="modal-dialog">
                                                            <div class="modal-content">
                                                                <form id="scoreForm" method="POST"
                                                                    action="/club/matches/register_score">
                                                                    <div class="modal-header">
                                                                        <h5 class="modal-title" id="scoreModalLabel">
                                                                            Registrar resultado
                                                                            del partido <span
                                                                                id="modalMatchNumber"></span>
                                                                        </h5>
                                                                        <button type="button" class="btn-close"
                                                                            data-bs-dismiss="modal"
                                                                            aria-label="Close"></button>
                                                                    </div>
                                                                    <div class="modal-body">
                                                                        <input type="hidden" name="match_id"
                                                                            id="modalMatchId">
                                                                        <div class="mb-3">
                                                                            <label class="form-label">Marcador por
                                                                                set</label>
                                                                            <div class="row g-2 mb-2">
                                                                                <div class="col-5">
                                                                                    <input type="number" min="0"
                                                                                        class="form-control"
                                                                                        name="set1_teamA"
                                                                                        id="set1_teamA"
                                                                                        placeholder="Equipo A Set 1"
                                                                                        required>
                                                                                </div>
                                                                                <div class="col-2 text-center">-</div>
                                                                                <div class="col-5">
                                                                                    <input type="number" min="0"
                                                                                        class="form-control"
                                                                                        name="set1_teamB"
                                                                                        id="set1_teamB"
                                                                                        placeholder="Equipo B Set 1"
                                                                                        required>
                                                                                </div>
                                                                            </div>
                                                                            <div class="row g-2 mb-2">
                                                                                <div class="col-5">
                                                                                    <input type="number" min="0"
                                                                                        class="form-control"
                                                                                        name="set2_teamA"
                                                                                        id="set2_teamA"
                                                                                        placeholder="Equipo A Set 2"
                                                                                        required>
                                                                                </div>
                                                                                <div class="col-2 text-center">-</div>
                                                                                <div class="col-5">
                                                                                    <input type="number" min="0"
                                                                                        class="form-control"
                                                                                        name="set2_teamB"
                                                                                        id="set2_teamB"
                                                                                        placeholder="Equipo B Set 2"
                                                                                        required>
                                                                                </div>
                                                                            </div>
                                                                            <div class="row g-2 mb-2">
                                                                                <div class="col-5">
                                                                                    <input type="number" min="0"
                                                                                        class="form-control"
                                                                                        name="set3_teamA"
                                                                                        id="set3_teamA"
                                                                                        placeholder="Equipo A Set 3">
                                                                                </div>
                                                                                <div class="col-2 text-center">-</div>
                                                                                <div class="col-5">
                                                                                    <input type="number" min="0"
                                                                                        class="form-control"
                                                                                        name="set3_teamB"
                                                                                        id="set3_teamB"
                                                                                        placeholder="Equipo B Set 3">
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <div class="modal-footer">
                                                                        <button type="button" class="btn btn-secondary"
                                                                            data-bs-dismiss="modal">Cancelar</button>
                                                                        <button type="submit"
                                                                            class="btn btn-primary">Guardar
                                                                            resultado</button>
                                                                    </div>
                                                                </form>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <% } %>

                                                        <!-- Completed Tournament Summary (Conditional) -->
                                                        <% if (viewModel.view.isCompleted) { %>
                                                            <div class="card mb-4">
                                                                <div class="card-header">
                                                                    <h5><i class="fas fa-trophy me-2"></i>Torneo
                                                                        Finalizado
                                                                    </h5>
                                                                </div>
                                                                <div class="card-body">
                                                                    <p class="text-muted">Aquí se mostrará el resumen
                                                                        final
                                                                        del
                                                                        torneo y los resultados.</p>
                                                                    <!-- Final standings/results will go here -->
                                                                </div>
                                                            </div>
                                                            <% } %>

                                                                <!-- Courts Used Section -->
                                                                <div class="card mb-4">
                                                                    <div class="card-header">
                                                                        <h5><i
                                                                                class="fas fa-table-tennis me-2"></i>Pistas
                                                                            Utilizadas</h5>
                                                                    </div>
                                                                    <div class="card-body">
                                                                        <p class="mb-2"><strong>Pistas
                                                                                asociadas:</strong>
                                                                            <%= viewModel.courts ?
                                                                                viewModel.courts.length : 0 %>
                                                                        </p>
                                                                        <% if (viewModel.courts &&
                                                                            viewModel.courts.length> 0) { %>
                                                                            <ul class="list-group">
                                                                                <% viewModel.courts.forEach(function(court)
                                                                                    { %>
                                                                                    <li class="list-group-item">
                                                                                        <%= court.name %>
                                                                                    </li>
                                                                                    <% }); %>
                                                                            </ul>
                                                                            <% } else { %>
                                                                                <p class="text-muted">No hay pistas
                                                                                    asociadas a
                                                                                    este torneo.</p>
                                                                                <% } %>
                                                                    </div>
                                                                </div>

                                                                <% if (viewModel.view.isPending) { %>
                                                                    <div class="text-end mt-4">
                                                                        <form
                                                                            action="/club/tournaments/<%= viewModel.tournament.id %>/start"
                                                                            method="POST"
                                                                            onsubmit="return confirm('¿Estás seguro de que quieres comenzar este torneo? Una vez iniciado, no podrás añadir ni eliminar jugadores.');">
                                                                            <button type="submit"
                                                                                class="btn btn-success btn-lg"><i
                                                                                    class="fas fa-play-circle me-2"></i>Comenzar
                                                                                Torneo</button>
                                                                        </form>
                                                                    </div>
                                                                    <% } %>

                                                                        <% if (typeof mensaje !=='undefined' && mensaje)
                                                                            { %>
                                                                            <div class="modal fade" id="mensajeModal"
                                                                                tabindex="-1"
                                                                                aria-labelledby="mensajeModalLabel"
                                                                                aria-hidden="true">
                                                                                <div class="modal-dialog">
                                                                                    <div class="modal-content">
                                                                                        <div
                                                                                            class="modal-header bg-<%= mensajeTipo === 'warning' ? 'warning' : 'danger' %>">
                                                                                            <h5 class="modal-title"
                                                                                                id="mensajeModalLabel">
                                                                                                <i
                                                                                                    class="fas fa-exclamation-triangle me-2"></i>
                                                                                                <%= mensajeTipo==='warning'
                                                                                                    ? 'Aviso' : 'Error'
                                                                                                    %>
                                                                                            </h5>
                                                                                            <button type="button"
                                                                                                class="btn-close"
                                                                                                data-bs-dismiss="modal"
                                                                                                aria-label="Cerrar"></button>
                                                                                        </div>
                                                                                        <div class="modal-body">
                                                                                            <%= mensaje %>
                                                                                        </div>
                                                                                        <div class="modal-footer">
                                                                                            <button type="button"
                                                                                                class="btn btn-secondary"
                                                                                                data-bs-dismiss="modal">Cerrar</button>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                            <% } %>

                                                                                <!-- Modal para crear grupo de dos jugadores -->
                                                                                <div class="modal fade" id="groupModal"
                                                                                    tabindex="-1"
                                                                                    aria-labelledby="groupModalLabel"
                                                                                    aria-hidden="true"
                                                                                    data-tournament-id="<%= viewModel.tournament.id %>">
                                                                                    <div class="modal-dialog">
                                                                                        <div class="modal-content">
                                                                                            <form id="groupForm">
                                                                                                <div
                                                                                                    class="modal-header">
                                                                                                    <h5 class="modal-title"
                                                                                                        id="groupModalLabel">
                                                                                                        Crear grupo
                                                                                                        de dos jugadores
                                                                                                    </h5>
                                                                                                    <button
                                                                                                        type="button"
                                                                                                        class="btn-close"
                                                                                                        data-bs-dismiss="modal"
                                                                                                        aria-label="Cerrar"></button>
                                                                                                </div>
                                                                                                <div class="modal-body">
                                                                                                    <label
                                                                                                        for="groupPlayerSearch"
                                                                                                        class="form-label">Buscar
                                                                                                        y
                                                                                                        seleccionar
                                                                                                        jugadores</label>
                                                                                                    <input type="text"
                                                                                                        id="groupPlayerSearch"
                                                                                                        class="form-control mb-2"
                                                                                                        placeholder="Buscar jugadores..."
                                                                                                        autocomplete="off">
                                                                                                    <div id="groupPlayerList"
                                                                                                        class="list-group mb-2"
                                                                                                        style="max-height: 200px; overflow-y: auto;">
                                                                                                    </div>
                                                                                                    <div class="mb-2">
                                                                                                        <strong>Seleccionados:</strong>
                                                                                                        <ul id="selectedPlayers"
                                                                                                            class="list-group">
                                                                                                        </ul>
                                                                                                    </div>
                                                                                                </div>
                                                                                                <div
                                                                                                    class="modal-footer">
                                                                                                    <button
                                                                                                        type="button"
                                                                                                        class="btn btn-secondary"
                                                                                                        data-bs-dismiss="modal">Cancelar</button>
                                                                                                    <button
                                                                                                        type="submit"
                                                                                                        class="btn btn-primary"
                                                                                                        id="saveGroupBtn"
                                                                                                        disabled>Crear
                                                                                                        grupo</button>
                                                                                                </div>
                                                                                            </form>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                    </main>
                </div>
        </div>
        <script src="/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
        <script src="/swiper/swiper-bundle.min.js"></script>
        <script src="/assets/js/tournament/manage-tournament.js"></script>
</body>

</html>